# I tried to do this a fancier way with pyparsing but failed miserably...
import subprocess

##

#result=subprocess.check_output(['amcc_dump','--all','10.0.1.4/2'])
#result_string=result.decode('utf-8')

result_string = """
================================================================================
| DevID.Rev | FW Rev | Man ID | Prod ID | Aux Rev  | FW Timestamp (if CBA IPMC)|
================================================================================
| 10.0.1.4/1                                                                   |
--------------------------------------------------------------------------------
|      00.0 |  7.4.0 | 005d32 |    2807 | 00000000 |       1970-01-01 00:00:00 |
--------------------------------------------------------------------------------
| 10.0.1.4/2                                                                   |
--------------------------------------------------------------------------------
|      02.0 |  3.2.0 | 009d50 |    0acc | 59680f26 |       2017-07-14 00:24:06 |
--------------------------------------------------------------------------------
| 10.0.1.4/3                                                                   |
--------------------------------------------------------------------------------
|      02.0 |  3.2.0 | 009d50 |    0acc | 59680f26 |       2017-07-14 00:24:06 |
--------------------------------------------------------------------------------
| 10.0.1.4/5                                                                   |
--------------------------------------------------------------------------------
|      02.0 |  3.2.0 | 009d50 |    0acc | 59680f26 |       2017-07-14 00:24:06 |
--------------------------------------------------------------------------------
================================================================================
================================================================================
|  BAY |Det|Pre|Ena|Vok| Voltage | Current | Power | Alloc  | ID               |
================================================================================
| 10.0.1.4/2                                                                   |
--------------------------------------------------------------------------------
| AMC0 | Y | Y | Y | Y | 11.760V |  2464mA | 29.0W | 102.0W | 7600000116288e70 |
| AMC1 | N | N | N |   | 11.808V |    20mA |  0.2W |   0.0W |                  |
| AMC2 | Y | Y | Y | Y | 11.796V |  1556mA | 18.4W | 102.0W | b30000011635e770 |
| AMC3 | N | N | N |   | 11.736V |    16mA |  0.2W |   0.0W |                  |
|  CEN | Y | Y | Y | Y | 11.730V |  5264mA | 61.7W |  50.8W | 0800000136e00570 |
|  RTM | Y | Y | Y |   | 11.814V |  1640mA | 19.4W |  36.0W | cc000001272dff70 |
--------------------------------------------------------------------------------
| 10.0.1.4/3                                                                   |
--------------------------------------------------------------------------------
| AMC0 | Y | Y | Y | Y | 11.952V |    12mA |  0.1W |   1.6W | 08000000eaba3970 |
| AMC1 | N | N | N |   | 11.910V |    12mA |  0.1W |   0.0W |                  |
| AMC2 | N | N | N |   | 11.964V |    12mA |  0.1W |   0.0W |                  |
| AMC3 | N | N | N |   | 11.952V |    12mA |  0.1W |   0.0W |                  |
|  CEN | Y | Y | Y | Y | 11.970V |  1428mA | 17.1W |  25.2W | 6b0000011368ce70 |
|  RTM | Y | Y | Y |   | 11.970V |   360mA |  4.3W |  36.0W | b00000011cf62270 |
--------------------------------------------------------------------------------
| 10.0.1.4/5                                                                   |
--------------------------------------------------------------------------------
| AMC0 | N | N | N |   | 11.988V |     8mA |  0.1W |   0.0W |                  |
| AMC1 | N | N | N |   | 11.952V |     8mA |  0.1W |   0.0W |                  |
| AMC2 | N | N | N |   | 11.982V |     8mA |  0.1W |   0.0W |                  |
| AMC3 | N | N | N |   | 11.940V |     8mA |  0.1W |   0.0W |                  |
|  CEN | Y | Y | Y | Y | 11.916V |  1512mA | 18.0W |  50.8W | c80000012dacae70 |
|  RTM | N | N | N |   | 12.018V |     2mA |  0.0W |        |                  |
--------------------------------------------------------------------------------
================================================================================
================================================================================
|  AMC  | Pre | Ena | Vok | EKy | BOM |   Type   | BTemp | JTemp |             |
================================================================================
| 10.0.1.4/2                                                                   |
--------------------------------------------------------------------------------
| Bay 0 |  Y  |  Y  |  Y  |  Y  |  00 | 0000000a |   35C |       |             |
| Bay 2 |  Y  |  Y  |  Y  |  Y  |  00 | 0000000a |   37C |       |             |
--------------------------------------------------------------------------------
| 10.0.1.4/3                                                                   |
--------------------------------------------------------------------------------
| Bay 0 |  Y  |  Y  |  Y  |  Y  |  00 | 00000006 |   22C |       |             |
--------------------------------------------------------------------------------
| 10.0.1.4/5                                                                   |
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
================================================================================
================================================================================
| FPGA | Pre | Ena | Vok | BTemp | JTemp |                                      
================================================================================
| 10.0.1.4/2                                                                   |
--------------------------------------------------------------------------------
|  CEN |  Y  |  Y  |  Y  |  42C  |  60C  |                                     |
--------------------------------------------------------------------------------
| 10.0.1.4/3                                                                   |
--------------------------------------------------------------------------------
|  CEN |  Y  |  Y  |  Y  |  29C  |  37C  |                                     |
--------------------------------------------------------------------------------
| 10.0.1.4/5                                                                   |
--------------------------------------------------------------------------------
|  CEN |  Y  |  Y  |  Y  |  32C  |  43C  |                                     |
--------------------------------------------------------------------------------
================================================================================
================================================================================
| RTM | Pre | Ena | Alloc |   Type   | BTemp | JTemp |                         |
================================================================================
| 10.0.1.4/1                                                                   |
--------------------------------------------------------------------------------
| RTM |  N  |  N  |       |          |       |       |                         |
| 10.0.1.4/2                                                                   |
--------------------------------------------------------------------------------
| RTM |  Y  |  Y  |  36.0 | 00000011 |   25C |       | Handle closed           |
| RMB |  N  |  N  |       |          |       |       |                         |
--------------------------------------------------------------------------------
| 10.0.1.4/3                                                                   |
--------------------------------------------------------------------------------
| RTM |  Y  |  Y  |  36.0 | 00000007 |   21C |       | Handle closed           |
| RMB |  N  |  N  |       |          |       |       |                         |
--------------------------------------------------------------------------------
| 10.0.1.4/5                                                                   |
--------------------------------------------------------------------------------
| RTM |  N  |  N  |       |          |       |       |                         |
================================================================================
================================================================================
| AMCc\GPIO | Det | Done |  Vok |  Pwr/5 |                                     |
================================================================================
| 10.0.1.4/2                                                                   |
--------------------------------------------------------------------------------
|      AMC0 | 0x1 |      | 0xff | 0x01fe |                                     |
|      AMC2 | 0x1 |      | 0xff | 0x01fe |                                     |
|       CEN |     | 0x10 | 0xff | 0x00fe |                                     |
|      IPMC | Switches:    0xc0 |                                              |
--------------------------------------------------------------------------------
| 10.0.1.4/3                                                                   |
--------------------------------------------------------------------------------
|      AMC0 | 0x1 |      | 0xff | 0x0008 |                                     |
|       CEN |     | 0x10 | 0xff | 0x007e |                                     |
|      IPMC | Switches:    0x00 |                                              |
--------------------------------------------------------------------------------
| 10.0.1.4/5                                                                   |
--------------------------------------------------------------------------------
|       CEN |     | 0x10 | 0xff | 0x00fe |                                     |
|      IPMC | Switches:    0x00 |                                              |
--------------------------------------------------------------------------------
================================================================================
================================================================================
|  Bay Raw GPIO  | Bank |   Input  |  Output  | Polarity |  Config  | Int Mask |
================================================================================
| 10.0.1.4/2                                                                   |
--------------------------------------------------------------------------------
|   0:     0x20  |    0 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   0:     0x20  |    1 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   0:     0x20  |    2 |   0xff   |   0x00   |   0x00   |   0xff   |   0xff   |
|   0:     0x20  |    3 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   0:     0x20  |    4 |   0xff   |   0x00   |   0x00   |   0xff   |   0xff   |
--------------------------------------------------------------------------------
|   2:     0x20  |    0 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   2:     0x20  |    1 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   2:     0x20  |    2 |   0xff   |   0x00   |   0x00   |   0xff   |   0xff   |
|   2:     0x20  |    3 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   2:     0x20  |    4 |   0xff   |   0x00   |   0x00   |   0xff   |   0xff   |
--------------------------------------------------------------------------------
|   4:     0x20  |    0 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    1 |   0x10   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    2 |   0xff   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    3 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    4 |   0x7f   |   0x00   |   0x00   |   0xff   |   0xff   |
--------------------------------------------------------------------------------
|   5            |    0 |   0x07   |   0x04   |   0x00   |   0xfb   |          |
--------------------------------------------------------------------------------
| 10.0.1.4/3                                                                   |
--------------------------------------------------------------------------------
|   0:     0x20  |    0 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   0:     0x20  |    1 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   0:     0x20  |    2 |   0xff   |   0x00   |   0x00   |   0xff   |   0xff   |
|   0:     0x20  |    3 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   0:     0x20  |    4 |   0x04   |   0x00   |   0x00   |   0xff   |   0xff   |
--------------------------------------------------------------------------------
|   4:     0x20  |    0 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    1 |   0x10   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    2 |   0xff   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    3 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    4 |   0x3f   |   0x00   |   0x00   |   0xff   |   0xff   |
--------------------------------------------------------------------------------
|   5            |    0 |   0x07   |   0x04   |   0x00   |   0xfb   |          |
--------------------------------------------------------------------------------
| 10.0.1.4/5                                                                   |
--------------------------------------------------------------------------------
|   4:     0x20  |    0 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    1 |   0x10   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    2 |   0xff   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    3 |   0x00   |   0x00   |   0x00   |   0xff   |   0xff   |
|   4:     0x20  |    4 |   0x7f   |   0x00   |   0x00   |   0xff   |   0xff   |
--------------------------------------------------------------------------------
================================================================================
"""

tablebreak='================================================================================'
ipslotbreak='--------------------------------------------------------------------------------'

## break into tables
split_result_string=result_string.split(tablebreak)
# drop white space
split_result_string = filter(None,[s for s in split_result_string if not s.isspace()])

amcc_dump_dict = {}
# loop over tables in returned data
for ii in range(0,len(split_result_string),2):
    header = split_result_string[ii]
    table = split_result_string[ii+1]

    split_header=header.split('|')
    split_header = filter(None,[s.lstrip().rstrip() for s in split_header if not s.isspace()])

    split_table=table.split(ipslotbreak)
    split_table = filter(None,[s for s in split_table if not s.isspace()])

    # loop over ip/slot combinations in returned data
    for jj in range(0,len(split_table),2):
        ipslot = split_table[jj]
        table2 = split_table[jj+1]

        split_ipslot=ipslot.split('|')
        split_ipslot = filter(None,[s.lstrip().rstrip() for s in split_ipslot if not s.isspace()])
        ip=split_ipslot[0].split('/')[0]
        slot=split_ipslot[0].split('/')[1]

        sh0=split_header[0]
        if ip not in amcc_dump_dict.keys():
            amcc_dump_dict[ip]={}
        if int(slot) not in amcc_dump_dict[ip].keys():
            amcc_dump_dict[ip][int(slot)]={}

        if sh0 not in amcc_dump_dict[ip][int(slot)].keys():
            amcc_dump_dict[ip][int(slot)][sh0]={}

        #if sh0 is 'BAY':
        if sh0=="BAY":
            split_table2=table2.split('\n')
            split_table2=filter(None,[s.lstrip().rstrip() for s in split_table2])
            for split_table3 in split_table2:
                split_table3=split_table3.split('|')
                split_table3 = filter(None,[s for s in split_table3])
                for kk in range(len(split_header)):
                    st3k=split_table3[0].lstrip().rstrip()
                    
                    if st3k not in amcc_dump_dict[ip][int(slot)][sh0].keys():
                        amcc_dump_dict[ip][int(slot)][sh0][st3k]={}

                #if st3k not in amcc_dump_dict[sh0][ip][int(slot)].keys():
                #    amcc_dump_dict[sh0][ip][int(slot)][split_header[kk]][st3k]={}
                #
                #amcc_dump_dict[sh0][ip][int(slot)][split_header[kk]][st3k] = \
                #    split_table3[kk].lstrip().rstrip()
                #print(amcc_dump_dict[sh0][ip][int(slot)][split_header[kk]])

    if ii>2:
        break

print(amcc_dump_dict.keys())
print(amcc_dump_dict['10.0.1.4'].keys())
print(amcc_dump_dict['10.0.1.4'][2])
